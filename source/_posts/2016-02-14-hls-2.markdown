---
layout: post
title: "HLS-iOSè§†é¢‘æ’­æ”¾æœåŠ¡æ¶æ„æ·±å…¥æ¢ç©¶ï¼ˆäºŒï¼‰"
date: 2016-02-14 18:51:24 +0800
comments: true
categories: ios
---

HLS-Demoåœ°å€ï¼š[https://github.com/yangchao0033/HLS-Demo](https://github.com/yangchao0033/HLS-Demo)

**ä½¿ç”¨demoå‰è¯·æ³¨æ„ä¸‹é¢çš„é—®é¢˜ï¼Œæˆ‘åœ¨ä»£ç ä¸­ä¹Ÿåšäº†æ³¨é‡Šã€‚**

```objc
//#warning æ³¨æ„ï¼Œä¸è¦ç›´æ¥ä½¿ç”¨åˆ‡æ¢æµçš„ä¸»ç´¢å¼•ï¼Œå½“å‰ä»£ç çš„åè®®åªæä¾›å¯¹.tså®šä½çš„å­ç´¢å¼•çš„ä¸‹è½½å’Œæ’­æ”¾ï¼Œè€Œä¸”å…¶ä¸­åªæœ‰ç‚¹æ’­åè®®é‚£ä¸€å°æ®µæ˜¯å¯ä»¥ä¸‹è½½çš„ï¼Œç›´æ’­åè®®åªèƒ½æ’­æ”¾ï¼Œæ— æ³•ä¸‹è½½ï¼Œæ— æ³•ä¸‹è½½çš„åŸå› æ˜¯å› ä¸ºm3u8çš„é‚£ä¸ªåº“ä¸­åªå¯¹ç‰¹å®šçš„ä¸€ç§m3u8çš„æ ¼å¼åšäº†è§£æï¼Œè€Œm3u8çš„æ ¼å¼æœ‰å¾ˆå¤šç§ï¼Œæ‰€ä»¥æ— æ³•åŠ æ¯å‡ºæ¥ï¼Œè¯¥demoåªåšæ¼”ç¤ºï¼Œä¸ä¼šå¯¹æ‰€æœ‰æ ¼å¼è¿›è¡Œå…¨è§£æï¼Œå¦‚æœå¤§å®¶æ„Ÿå…´è¶£çš„è¯å¯ä»¥å¯¹m3u8çš„åº“è¿›è¡Œæ‰©å±•ï¼Œåœ¨github ä¸Š pull request æˆ‘åšä¸€ä¸ªè¡¥å……æ‰©å±•ğŸ˜ï¼Œæˆ‘ä¼šåŠæ—¶åœ¨åšå®¢ä¸­è¿›è¡Œæ›´æ–°ã€‚åšå®¢åœ°å€ï¼šsuperyang.gitcafe.ioæˆ–yangchao0033.github.io åŒç®€ä¹¦ï¼šhttp://www.jianshu.com/users/f37a8f0ba6f8/latest_articles

/** ç‚¹æ’­åè®® (åªæœ‰è¿™ä¸ªæ˜¯å¯ä»¥ä¸‹è½½çš„ï¼Œä½†æ˜¯è‹¦äºå¤ªçŸ­ï¼Œæ²¡åŠæ³•æ’­æ”¾å‡ºæ¥ï¼Œæ­£åœ¨å¯»æ‰¾å¯ä»¥ä¸‹è½½å¹¶æ’­æ”¾çš„æ–°çš„ç‚¹æ’­æˆ–ç›´æ’­æº,å¸Œæœ›æœ‰è¯»è€…å¯ä»¥å¸®å¿™æä¾›å“ˆï¼Œä¸ç”šæ„Ÿæ¿€~)*/
//#define TEST_HLS_URL @"http://m3u8.tdimg.com/147/806/921/3.m3u8"
/** è§†é¢‘ç›´æ’­åè®® */
/** çˆ¶ç´¢å¼•(æ— æ³•ä¸‹è½½ï¼Œåªä½œä¸ºç»“æ„åˆ†æ) */
//#define TEST_HLS_URL @"http://dlhls.cdn.zhanqi.tv/zqlive/34338_PVMT5.m3u8"
/** å­ç´¢å¼•(æ— æ³•ä¸‹è½½ï¼Œåªä½œä¸ºç»“æ„åˆ†æ) */
//#define TEST_HLS_URL @"http://dlhls.cdn.zhanqi.tv/zqlive/34338_PVMT5_1024/index.m3u8?Dnion_vsnae=34338_PVMT5"
/** wwcdè§†é¢‘ï¼Œæœç„¶è‹¹æœè‡ªå·±å°±ç”¨è¿™ä¸ªåè®®(æ— æ³•ä¸‹è½½ï¼Œåªä½œä¸ºç»“æ„åˆ†æ) */
//#define TEST_HLS_URL @"http://devstreaming.apple.com/videos/wwdc/2015/413eflf3lrh1tyo/413/hls_vod_mvp.m3u8"
```

å¦‚æœè§‰å¾—æ–‡ç« æœ‰ç”¨çš„è¯ï¼Œè¯·è¯»è€…åœ¨githubä¸Šç‚¹ä¸ªstarğŸ˜ï¼Œæˆ–è€…åœ¨[ç®€ä¹¦](http://www.jianshu.com/users/f37a8f0ba6f8/latest_articles)ä¸Šç‚¹ä¸ªèµã€‚

Demoé…ç½®åŸç†ï¼š

1ã€ éœ€è¦å¯¼å…¥ç¬¬ä¸‰æ–¹åº“ï¼šASIHttpRequestï¼ŒCocoaHTTPServerï¼Œm3u8ï¼ˆå…¶ä¸­ASIç”¨äºç½‘ç»œè¯·æ±‚ï¼ŒCocoaHTTPServerç”¨äºåœ¨iosç«¯æ­å»ºæœåŠ¡å™¨ä½¿ç”¨ï¼Œm3u8æ˜¯ç”¨æ¥å¯¹è¿”å›çš„ç´¢å¼•æ–‡ä»¶è¿›è¡Œè§£æçš„ï¼‰
<!--more-->
![ASIé…ç½®æ³¨æ„äº‹é¡¹](https://github.com/yangchao0033/HLS-Demo/blob/master/%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%831.png?raw=true)

![MRCæŠ¥é”™å¤„ç†](https://github.com/yangchao0033/HLS-Demo/blob/master/%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%832.png?raw=true)

2ã€å¯¼å…¥ç³»ç»Ÿåº“ï¼šlibsqlite3.dylibã€libz.dylibã€libxml2.dylibã€CoreTelephony.frameworkã€SystemConfiguration.frameworkã€MobileCoreServices.frameworkã€Security.frameworkã€CFNetwork.frameworkã€MediaPlayer.framework

3ã€æ·»åŠ å¤´æ–‡ä»¶

```c
YCHLS-Demo.h
```

4ã€demoä»‹ç»
![demoæ ·å¼](https://github.com/yangchao0033/yangchao0033.github.io/blob/source/images/ios/2016/2/HLS_demo_UI.png?raw=true)

* __æ’­æ”¾ï¼š__ç›´æ¥æ’­æ”¾åœ¨çº¿çš„ç›´æ’­é“¾æ¥ï¼Œæ˜¯ç”±ç³»ç»Ÿçš„MPMoviePlayerå®Œæˆçš„ï¼Œå®ƒè‡ªå¸¦è§£æHLSç›´æ’­é“¾çš„åŠŸèƒ½ã€‚
* __ä¸‹è½½ï¼š__éµå¾ªHLSçš„åè®®ï¼Œé€šè¿‡ç´¢å¼•æ–‡ä»¶çš„èµ„æºè·¯å¾„ä¸‹è½½ç›¸å…³çš„è§†é¢‘åˆ‡ç‰‡å¹¶ä¿å­˜åˆ°æ‰‹æœºæœ¬åœ°ã€‚
* __æ’­æ”¾æœ¬åœ°è§†é¢‘ï¼š__ä½¿ç”¨ä¸‹è½½å¥½çš„è§†é¢‘æ–‡ä»¶ç‰‡æ®µè¿›è¡Œè¿ç»­æ’­æ”¾ã€‚
* __æ¸…é™¤ç¼“å­˜ï¼š__åˆ é™¤ä¸‹è½½å¥½çš„è§†é¢‘ç‰‡æ®µ

åŸç†ï¼š

1. é€šè¿‡ASIè¯·æ±‚é“¾æ¥ï¼Œé€šè¿‡m3u8åº“è§£æè¿”å›çš„m3u8ç´¢å¼•æ–‡ä»¶ã€‚
2. å†é€šè¿‡ASIä¸‹è½½è§£æå‡ºçš„è§†é¢‘èµ„æºåœ°å€ï¼Œä»¿ç…§HLSä¸­æ–‡ä»¶å­˜å‚¨è·¯å¾„å­˜å‚¨ã€‚
3. åˆ©ç”¨CocoaHTTPServeråœ¨iOSç«¯æ­å»ºæœ¬åœ°æœåŠ¡å™¨ï¼Œå¹¶å¼€å¯æœåŠ¡ï¼Œç«¯å£å·ä¸ºï¼š12345ï¼ˆé«˜ä½ç«¯å£å³å¯ï¼‰ã€‚é…ç½®æœåŠ¡å™¨è·¯å¾„ä¸æ­¥éª¤äºŒå­˜å‚¨è·¯å¾„ä¸€è‡´ã€‚
4. è®¾ç½®æ’­æ”¾å™¨ç›´æ’­é“¾æ¥ä¸ºæœ¬åœ°æœåŠ¡å™¨åœ°å€ï¼Œç›´æ¥æ’­æ”¾ï¼Œç”±äºæ’­æ”¾å™¨éµå®ˆHLSåè®®ï¼Œæ‰€ä»¥èƒ½å¤Ÿè§£ææˆ‘ä»¬ä¹‹å‰ä½¿ç”¨HLSåè®®æ­å»ºçš„æœ¬åœ°æœåŠ¡å™¨åœ°å€ã€‚
5. ç‚¹å‡»åœ¨çº¿æ’­æ”¾ï¼Œæ ¡éªŒæ˜¯å¦ä¸æœ¬åœ°æ’­æ”¾æ•ˆæœä¸€è‡´ã€‚

![HLSåè®®æ–‡ä»¶å­˜å‚¨ç»“æ„](https://github.com/yangchao0033/yangchao0033.github.io/blob/source/images/ios/2016/2/HLS%E5%8D%8F%E8%AE%AE%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%20.png?raw=true)

ä¸Šé¢æ˜¯HLSä¸­æœåŠ¡å™¨å­˜å‚¨è§†é¢‘æ–‡ä»¶åˆ‡ç‰‡å’Œç´¢å¼•æ–‡ä»¶çš„ç»“æ„å›¾

æ•´ä¸ªæ“ä½œæµç¨‹å°±æ˜¯ï¼š

1. å…ˆç‚¹å‡»ä¸‹è½½ï¼Œé€šè¿‡è§£æm3u8çš„ç¬¬ä¸‰æ–¹åº“è§£æèµ„æºã€‚ï¼ˆm3u8çš„é‚£ä¸ªåº“åªèƒ½è§£æä¸€ç§ç‰¹å®šæ ¼å¼çš„m3u8æ–‡ä»¶ï¼Œä»£ç é‡Œä¼šæœ‰æ ‡æ³¨ï¼‰
2. ç‚¹å‡»æ’­æ”¾æœ¬åœ°è§†é¢‘æ’­æ”¾ä¸‹è½½å¥½çš„èµ„æºã€‚
3. ç‚¹å‡»æ’­æ”¾æ˜¯ç”¨æ¥é¢„è§ˆç›´æ’­çš„æ•ˆæœï¼Œä¸æ•´ä¸ªæµç¨‹æ— å…³ã€‚
4. å…¶ä¸­è¿›åº¦æ¡ç”¨æ¥æ˜¾ç¤ºä¸‹è½½è¿›åº¦ã€‚

> æ€»ç»“ï¼š
> æ•´ä¸ªDemoå¹¶ä¸åªæ˜¯è®©æˆ‘ä»¬æ­å»ºä¸€ä¸ªHlsæœåŠ¡å™¨æˆ–è€…ä¸€ä¸ªæ”¯æŒHlsçš„æ’­æ”¾å™¨ã€‚ç›®çš„åœ¨äºäº†è§£Hlsåè®®çš„å…·ä½“å®ç°ï¼Œä»¥åŠæœåŠ¡å™¨ç«¯çš„ä¸€äº›ç‰©ç†æ¶æ„ã€‚é€šè¿‡Demoçš„å­¦ä¹ ï¼Œå¯ä»¥è¯¦ç»†çš„äº†è§£Hlsç›´æ’­å…·ä½“çš„å®ç°æµç¨‹ã€‚

éƒ¨åˆ†æºç è´´å‡ºï¼š

å¼€å¯æœ¬åœ°æœåŠ¡å™¨ï¼š

```objc
- (void)openHttpServer
{
    self.httpServer = [[HTTPServer alloc] init];
    [self.httpServer setType:@"_http._tcp."];  // è®¾ç½®æœåŠ¡ç±»å‹
    [self.httpServer setPort:12345]; // è®¾ç½®æœåŠ¡å™¨ç«¯å£
    
    // è·å–æœ¬åœ°Library/Cacheè·¯å¾„ä¸‹downloadsè·¯å¾„
    NSString *webPath = [kLibraryCache stringByAppendingPathComponent:kPathDownload];
    NSLog(@"-------------\nSetting document root: %@\n", webPath);
    // è®¾ç½®æœåŠ¡å™¨è·¯å¾„
    [self.httpServer setDocumentRoot:webPath];
    NSError *error;
    if(![self.httpServer start:&error])
    {
        NSLog(@"-------------\nError starting HTTP Server: %@\n", error);
    }
```

è§†é¢‘ä¸‹è½½ï¼š

```objc
- (IBAction)downloadStreamingMedia:(id)sender {
    
    UIButton *downloadButton = sender;
    // è·å–æœ¬åœ°Library/Cacheè·¯å¾„
    NSString *localDownloadsPath = [kLibraryCache stringByAppendingPathComponent:kPathDownload];
    
    // è·å–è§†é¢‘æœ¬åœ°è·¯å¾„
    NSString *filePath = [localDownloadsPath stringByAppendingPathComponent:@"XNjUxMTE4NDAw/movie.m3u8"];
    NSFileManager *fileManager = [NSFileManager defaultManager];
    // åˆ¤æ–­è§†é¢‘æ˜¯å¦ç¼“å­˜å®Œæˆï¼Œå¦‚æœå®Œæˆåˆ™æ’­æ”¾æœ¬åœ°ç¼“å­˜
    if ([fileManager fileExistsAtPath:filePath]) {
        [downloadButton setTitle:@"å·²å®Œæˆ" forState:UIControlStateNormal];
        downloadButton.enabled = NO;
    }else{
        M3U8Handler *handler = [[M3U8Handler alloc] init];
        handler.delegate = self;
        // è§£æm3u8è§†é¢‘åœ°å€
        [handler praseUrl:TEST_HLS_URL];
        // å¼€å¯ç½‘ç»œæŒ‡ç¤ºå™¨
        [[UIApplication sharedApplication] setNetworkActivityIndicatorVisible:YES];
    }
}
```
æ’­æ”¾æœ¬åœ°è§†é¢‘ï¼š


```objc
- (IBAction)playVideoFromLocal:(id)sender {
    
    NSString * playurl = [NSString stringWithFormat:@"http://127.0.0.1:12345/XNjUxMTE4NDAw/movie.m3u8"];
    NSLog(@"æœ¬åœ°è§†é¢‘åœ°å€-----%@", playurl);
    
    // è·å–æœ¬åœ°Library/Cacheè·¯å¾„
    NSString *localDownloadsPath = [kLibraryCache stringByAppendingPathComponent:kPathDownload];
    // è·å–è§†é¢‘æœ¬åœ°è·¯å¾„
    NSString *filePath = [localDownloadsPath stringByAppendingPathComponent:@"XNjUxMTE4NDAw/movie.m3u8"];
    NSFileManager *fileManager = [NSFileManager defaultManager];
    
    // åˆ¤æ–­è§†é¢‘æ˜¯å¦ç¼“å­˜å®Œæˆï¼Œå¦‚æœå®Œæˆåˆ™æ’­æ”¾æœ¬åœ°ç¼“å­˜
    if ([fileManager fileExistsAtPath:filePath]) {
        MPMoviePlayerViewController *playerViewController =[[MPMoviePlayerViewController alloc]initWithContentURL:[NSURL URLWithString: playurl]];
        [self presentMoviePlayerViewControllerAnimated:playerViewController];
    }
    else{
        UIAlertView *alertView = [[UIAlertView alloc] initWithTitle:@"Sorry" message:@"å½“å‰è§†é¢‘æœªç¼“å­˜" delegate:self cancelButtonTitle:@"ç¡®å®š" otherButtonTitles:nil, nil];
        [alertView show];
    }
}
```

æ’­æ”¾åœ¨çº¿è§†é¢‘

```objc
- (IBAction)playLiveStreaming {
    
    NSURL *url = [[NSURL alloc] initWithString:TEST_HLS_URL];
    MPMoviePlayerViewController *player = [[MPMoviePlayerViewController alloc] initWithContentURL:url];
    [self presentMoviePlayerViewControllerAnimated:player];
}
```

å½“ç„¶ï¼Œã€ŠèŠˆæœˆä¼ ã€‹çš„ç›´æ’­é“¾æ¥åˆ°ç°åœ¨ä¹Ÿè¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œå„ä½çƒ­å¿ƒè¯»è€…å¦‚æœæœ‰é“¾æ¥çš„è¯å¯ä»¥ç•™è¨€ç»™æˆ‘ï¼Œä¹Ÿè®©è¿™ç¯‡æ–‡ç« èƒ½å®è‡³åå½’äº†ï¼Œèƒ½å¯¹å¾—æ–‡ç« çš„æ ‡é¢˜äº†ğŸ˜ã€‚
